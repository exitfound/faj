# Fully Automated Jenkins

FAJ – это репозиторий, предназначенный для автоматического развертывания предварительно настроенного Jenkins, с помощью такого инструмента автоматизации, как Ansible. Концепт предварительно настроенного Jenkins достигается за счет таких двух инструментов, как Docker (для запуска самого Jenkins с необходимыми системными параметрами) и плагина CasC (для описания конфигурации Jenkins в виде кода). Помимо этого, средствами всё того же Ansible, опционально, можно осуществить мануальную установку Jenkins, подготовить узел к роли Jenkins Agent, а также настроить Nginx + SSL, для проксирования запросов, и т.д.

## Мотивация:

Мотивацией послужила задача из частного случая, когда у нас есть N-ое количество окружений, и под каждое окружение выделяется отдельный Jenkins, для последующей работы с этим самым окружением. Следовательно, такой Jenkins необходимо подготовить, со всеми его заданиями, учетными данными, пользователями, настройками Github и Gitlab, и т.д. С ростом числа окружений возрастает и количество Jenkins, которые будут задействованы. Исходя из этого возникает как желание, так и потребность в том, чтобы такой Jenkins уже обладал хотя бы базовыми настройками, применимыми во всех случаях. Именно это и пытается решить данный репозиторий.

## Предустановка:

Для успешного запуска необходимо установить минимальное количество программных коммпонентов. В частности, это:

- Git на сервере, с помощью которого вами будет загружен репозиторий из Github.

- Docker и Docker-compose на сервере, средствами которых осуществялется классическое (в представлении этого репозитория) развертывание Jenkins в системе.

- Ansible на вашем клиентском узле, если собираетесь развертывать Jenkins на двух или более серверах с разными ОС.

- Пользователь с правами sudo на серверах, из под которого будут запускаться плейбуки на каждом из серверов.

## Структура репозитория:

По умолчанию, если вы попытаетесь развернуть Jenkins с помощью данного репозитория, то процесс установки и запуска будет успешно завершен (исключением является изменение работы самого Jenkins). Однако, если вы хотите изменить вводные данные, такие, например, как плагины с их версиями или учетные данные пользователя, то в таком случае понадобятся изменения содержимого в файлах. Ниже представлено краткое описание того, что собой представляет каждый из файлов в корне репозитория:

- Dockerfile: Файл для сборки индивидуального образа, который используется для запуска Jenkins, с помощью docker-compose.

- jenkins-docker-compose.yaml: Файл для непосредственного запуска Jenkins на базе образа, полученного с помощью Dockerfile.

- plugins.txt: Файл, содержащий список плагинов, которые будут установлены в Jenkins во время его сборки. Для некоторых плагинов указана конкретная версия, так как не редко бывает, что обновление плагина ломает как некоторую функциональность, так и Jenkins в целом. Впрочем, жесткая привязка версии плагина является опциональным действием.

- .env: Файл, содержащий список переменных, которые прописаны в конфигурационных файлах для плагина CasC. В общей сложности здесь отмечены самые часто изменяемые параметры в Jenkins. Например такие, как данные пользователя, общие настройки и т.д.

- jcasc: Директория с конфигурационными файлами, которые используются для описания Jenkins в виде кода. В них же, вместо жесткой привязки какого-либо значения, указана переменная, ссылающаяся на файл .env.

- ansible: Директория, которая целиком и полностью предназначена для развертывания Jenkins с помощью такого инструмента автоматизации, как Ansible.

## Классическое развертывание Jenkins:

Классическое развертывание подразумевает под собой запуск Jenkins без участия Ansible в цепочке. Это на тот случай, если кто-то с ним не знаком, не хочет его использовать и т.д. Концепция применения остается неизменной, что при наличии, что при отсутствии Ansible. После того как проект был склонирован, необходимо перейти в директорию и запустить docker-compose, чтобы начался процесс сборки и запуска Jenkins. Выглядеть это будет следующим образом:

```
docker-compose -f jenkins-docker-compose.yaml up -d
```

Примечание: По умолчанию в файле jenkins-docker-compose.yaml указано, что Jenkins будет запущен с адресом 127.0.0.1:8080, что означает, что он будет доступен только для того инстанса, на котором был запущен. Сделано это было так потому, чтобы до Jenkins нельзя было достучаться из вне, так как подразумевается, что между ним и клиентом ещё будет присутствовать Nginx, который спроксирует поступающие запросы. Если вы хотите, чтобы Jenkins был доступен для всего мира, необходимо в файле jenkins-docker-compose.yaml изменить 127.0.0.1 на 0.0.0.0.

После того как Jenkins был успешно запущен, можно обратиться к его панели, введя в адресной строке публичный IP-адрес или домен (учитывая изменения, указанные в примечании выше). Вместо привычной инициализации нас сразу просят ввести пользователя и пароль. Ниже представлены учетные данные для входа по умолчанию:

```
Login: admin
Password: Kitezh1165
```

Однако, значения параметров можно изменить, если перед запуском поменять содержимое следующих двух переменных в файле .env:

```
JCASC_JENKINS_ADMIN_USER="admin"
JCASC_JENKINS_ADMIN_PASSWORD="Kitezh1165"
```

## Развертывание Jenkins с помощью Ansible:

Развертывание с помощью такого инструмента автоматизации как Ansible подразумевает под собой всё то же классическое развертывание Jenkins, только по отношению к множественному числу узлов, и в автоматическом режиме. Присутствие Ansible не отменяет того факта, что вы также можете (при желании) изменить содержимое конфигурационных файлов, переменных и т.д. Только теперь всё это вписано в структуру самого Asnible. Так, например, аналогом файла .env для Ansible является файл ./ansible/group_vars/all.yaml. Файлы же, связанные с Docker, располагаются в соответствующей роли, именуемой как docker-jenkins. Не стоит забывать и о файле ./ansible/hosts/servers, который необходимо заполнить реальной информацией о своих серверах. Стоит также понимать, что полный процесс автоматизации в контексте Ansible присущ только роли, где Jenkins запускается с помощью Docker, поскольку именно ради этого всё и задумывалось. Однако, в качестве бонуса, были добавлены и другие роли, среди которых, например, роль по мануальному развертыванию Jenkins (без Docker) или роль, настраивающая Jenkins Agent на узле. Итак, для запуска основного плейбука, предназначенного для развертывания заранее настроенного Jenkins, необходимо выполнить следующую команду:

```
ansible-playbook -i ./ansible/hosts/servers -u <your-user-deploy> ./ansible/docker-jenkins.yaml
```

Если вы хотите применить плейбук по отношению к конкретной группе узлов (например, только все инстансы Ubuntu), то в таком случае можно добавить параметр -l:

```
ansible-playbook -i ./ansible/hosts/servers -l ubuntu -u <your-user-deploy> ./ansible/docker-jenkins.yaml
```

Опционально: Если вы хотите, чтобы один из серверов начал выступать в роли агента Jenkins, то в таком случае можно запустить плейбук, представленный ниже. По умолчанию на таком сервере будет создан пользователь с именем jenkins-agent. Если вы хотите данное имя изменить, необходимо внести свой вариант в файл ./ansible/group_vars/all.yaml. В данном случае речь идет о параметре jenkins_agent_user. Ещё необходимо указать публичную часть ключа, который будет использоваться для связи между Master и Agent:

```
ansible-playbook -i ./ansible/hosts/servers -u <your-user-deploy> ./ansible/manual-jenkins-agent.yaml
```

Опционально: Если вы хотите применить плейбук, который развернет Jenkins в мануальном стиле, то в таком случае необходимо выполнить следующую команду:

```
ansible-playbook -i ./ansible/hosts/servers -u <your-user-deploy> ./ansible/manual-jenkins.yaml
```

Опционально: Ранее уже был упомянут тот факт, что в случае с Docker по умолчанию Jenkins запускается от адреса 127.0.0.1. Это было сделано для того, чтобы до него нельзя было достучаться извне, а прослойкой между ним и внешним Миром выступал Nginx. Если вы хотите реализовать данный сценарий в полной мере, в таком случае необходимо прибегнуть к выполнению команды, расположенной ниже. Только как и в предыдущих случаях, необходимо указать доменное имя в виде переменной, с той разницей, что конкретно в этом случае значение переменной определяется в файле ./ansible/hosts/servers. К слову речь идет о переменной с именем jenkins_nginx_domain. Это сделано так потому, что нам необходимо гибко распределять имена между всеми серверами, поскольку имя должно быть уникальным в рамках каждого сервера:

```
ansible-playbook -i ./ansible/hosts/servers -u <your-user-deploy> ./ansible/nginx-with-certbot.yaml
```

Учетные данные для входа, как и процесс их изменения точно такой же, как и в случае с классическим развертыванием Jenkins:

```
Login: admin
Password: Kitezh1165

JCASC_JENKINS_ADMIN_USER="admin"
JCASC_JENKINS_ADMIN_PASSWORD="Kitezh1165"
```

## Миграция Jobs между Jenkins:

В качестве дополнения ко всему выше перечисленному также был создан скрипт, с помощью которого можно передать всё задания (jobs) с одного Jenkins на другой. В нашем случае это идеально подходит, когда мы сначала развертываем новый Jenkins со всеми необходимыми настройками, а после импортируем в него все задания, которые использовались в старом Jenkins. Пока что делает экспорт / импорт только заданий. Быть может в будущем функциональность будет расширена. Вывод помощи при использовании скрипта представлен ниже:
```
These are the possible options to use: 

        [ -o | --old-jenkins ]          Specify the address of the Old Jenkins from which you want to export jobs.
        [ -n | --new-jenkins ]          Specify the address of the Old Jenkins where you want to import the jobs.
        [ -u | --old-jenkins-user ]     Specify a user in Old Jenkins to access jobs.
        [ -p | --old-jenkins-password ] Specify a password for user in Old Jenkins to access jobs.
        [ -U | --new-jenkins-user ]     Specify a user in New Jenkins to upload jobs.
        [ -P | --new-jenkins-password ] Specify a password for user in New Jenkins to upload jobs.
        [ -h | --help ]                 General information about all options.

Usage: ./migrate-jobs.sh [OPTIONS] [ARGS]
```

Чтобы использовать сам скрипт со всеми необходимыми параметрами, нужно выполнить следующую команду:

```
./migrate-jobs.sh -o "http://your.old.jenkins:8080" -n "http://your.new.jenkins:8080" -u "your-user" -p "your-password" -U "admin" -P "Kitezh1165"
```

## Послесловие

В будущем планируются косметические улучшений разной степени, добавление дополнительных функций, связанных с Ansible, развитие скрипта по миграциям и т.д. Возможно, что также появится CI и Terraform, для ещё более быстрого и прозрачного развертывания Jenkins, хотя это и не так уж и необходимо. К слову, более детальное объяснение того, что здесь происходит описано вот в этой статье – https://t.me/opengrad/90.
